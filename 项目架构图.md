# FastAPI + OpenAI SDK Agent 项目架构图

## 项目结构

```
academic_draft_agentic_workflow/
│
├── app/
│   ├── __init__.py
│   │
│   ├── main.py                 # FastAPI 应用入口，路由注册
│   │
│   ├── config/
│   │   ├── __init__.py
│   │   └── settings.py         # 配置管理（环境变量、OpenAI API Key等）
│   │
│   ├── api/
│   │   ├── __init__.py
│   │   ├── deps.py             # 依赖注入（数据库、认证等）
│   │   └── v1/
│   │       ├── __init__.py
│   │       ├── router.py       # API 路由汇总
│   │       └── endpoints/
│   │           ├── __init__.py
│   │           ├── agent.py    # Agent 自定义 endpoint（流式/非流式）
│   │           └── health.py   # 健康检查 endpoint
│   │
│   ├── core/
│   │   ├── __init__.py
│   │   ├── agent.py            # Agent 核心逻辑类
│   │   ├── streaming.py        # 流式响应处理工具
│   │   └── schemas.py          # Pydantic 数据模型（请求/响应）
│   │
│   ├── services/
│   │   ├── __init__.py
│   │   └── openai_service.py   # OpenAI SDK 封装服务
│   │
│   └── utils/
│       ├── __init__.py
│       └── logger.py           # 日志配置
│
├── requirements.txt            # Python 依赖包
├── .env                        # 环境变量（不提交到 git）
├── .env.example               # 环境变量示例
├── .gitignore
└── README.md                   # 项目说明文档
```

## 核心模块说明

### 1. **app/main.py**
- FastAPI 应用实例创建
- 中间件配置（CORS、日志等）
- 路由注册
- 启动配置

### 2. **app/config/settings.py**
- 使用 `pydantic-settings` 管理配置
- OpenAI API Key、模型名称等配置
- 环境变量读取

### 3. **app/api/v1/endpoints/agent.py**
- **POST /api/v1/agent/chat** - 非流式对话 endpoint
- **POST /api/v1/agent/chat/stream** - 流式对话 endpoint
- 请求参数验证
- 响应格式化

### 4. **app/core/agent.py**
- Agent 类定义
- 消息历史管理
- 工具调用处理（为后续 workflow 预留）
- 对话逻辑封装

### 5. **app/core/streaming.py**
- Server-Sent Events (SSE) 流式响应生成器
- OpenAI 流式响应转换
- 错误处理

### 6. **app/core/schemas.py**
- `ChatRequest` - 聊天请求模型
- `ChatResponse` - 聊天响应模型
- `StreamChunk` - 流式数据块模型

### 7. **app/services/openai_service.py**
- OpenAI 客户端初始化
- ChatCompletion 调用封装
- 流式和非流式方法
- 错误处理和重试逻辑

## 技术栈

- **Web 框架**: FastAPI
- **AI SDK**: openai (官方 SDK)
- **数据验证**: Pydantic
- **配置管理**: pydantic-settings
- **流式响应**: Server-Sent Events (SSE)
- **异步支持**: Python asyncio

## API Endpoint 设计

### 非流式接口
```
POST /api/v1/agent/chat
Content-Type: application/json

Request Body:
{
  "message": "用户消息",
  "conversation_id": "可选：会话ID",
  "temperature": 0.7,
  "max_tokens": 1000
}

Response:
{
  "response": "AI回复",
  "conversation_id": "会话ID",
  "usage": {...}
}
```

### 流式接口
```
POST /api/v1/agent/chat/stream
Content-Type: application/json

Request Body: (同上)

Response: (SSE 流式)
data: {"chunk": "部分", "done": false}
data: {"chunk": "内容", "done": false}
data: {"chunk": "", "done": true, "usage": {...}}
```

## 扩展点（为 Agentic Workflow 预留）

1. **app/core/agent.py** - 可扩展为多 Agent 协调
2. **app/core/tools/** - 工具注册和执行（未来添加）
3. **app/core/workflow/** - Workflow 编排引擎（未来添加）
4. **app/services/memory/** - 持久化记忆管理（未来添加）

## 依赖包 (requirements.txt 示例)

```
fastapi>=0.104.0
uvicorn[standard]>=0.24.0
openai>=1.3.0
pydantic>=2.0.0
pydantic-settings>=2.0.0
python-dotenv>=1.0.0
```

